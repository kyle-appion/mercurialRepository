// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using UIKit;

using ION.Core.App;
using ION.Core.Content.Properties;
using ION.Core.Fluids;
using ION.Core.Sensors;
using ION.Core.Sensors.Properties;

using ION.IOS.Util;

namespace ION.IOS.ViewController.Workbench {
	public partial class FluidSubviewCell : UITableViewCell {

    private AbstractManifoldSensorProperty sensorProperty {
      get {
        return __sensorProperty;
      }
      set {
        if (__sensorProperty != null) {
          __sensorProperty.onSensorPropertyChanged -= OnSensorPropertyChanged;
        }

        __sensorProperty = value;

        if (__sensorProperty != null) {
          __sensorProperty.onSensorPropertyChanged += OnSensorPropertyChanged;
          OnSensorPropertyChanged(value);
        }
      }
    } AbstractManifoldSensorProperty __sensorProperty;

		public FluidSubviewCell (IntPtr handle) : base (handle) {
		}

    public void UpdateTo(PTChartSensorProperty property) {
      sensorProperty = property;
    }

    public void UpdateTo(SuperheatSubcoolSensorProperty property) {
      sensorProperty = property;
    }

    private void OnSensorPropertyChanged(ISensorProperty sensorProperty) {
      if (sensorProperty is SuperheatSubcoolSensorProperty) {
        HandleSuperheatSubcoolSensorPropertyChanged(this.sensorProperty as SuperheatSubcoolSensorProperty);
      } else {
        HandlePTChartSensorPropertyChanged(this.sensorProperty as PTChartSensorProperty);
      }
    }

    private void HandlePTChartSensorPropertyChanged(PTChartSensorProperty sensorProperty) {
      var ion = AppState.context;

      UpdateToFluid(sensorProperty.manifold.ptChart.fluid);

      switch (sensorProperty.manifold.ptChart.state) {
        case Fluid.EState.Bubble:
          this.labelTitle.Text = Strings.Fluid.PT_CHART_BUB;
          break;
        case Fluid.EState.Dew:
          labelTitle.Text = Strings.Fluid.PT_CHART_DEW;
          break;
        default:
          labelTitle.Text = Strings.UNKNOWN;
          break;
      }

      var meas = sensorProperty.sensor.measurement;
      var chart = sensorProperty.manifold.ptChart;
      switch (sensorProperty.sensor.type) {
        case ESensorType.Pressure:
          var temp = chart.GetTemperature(meas);
          temp = temp.ConvertTo(ion.defaultUnits.temperature);
          labelMeasurement.Text = SensorUtils.ToFormattedString(ESensorType.Temperature, temp, true);
          break;
        case ESensorType.Temperature:
          var press = chart.GetPressure(meas);
          press = press.ConvertTo(ion.defaultUnits.pressure); 
          labelMeasurement.Text = SensorUtils.ToFormattedString(ESensorType.Pressure, press, true);
          break;
      }
    }

    private void HandleSuperheatSubcoolSensorPropertyChanged(SuperheatSubcoolSensorProperty sensorProperty) {
      UpdateToFluid(sensorProperty.manifold.ptChart.fluid);

      switch (sensorProperty.manifold.ptChart.state) {
        case Fluid.EState.Bubble:
          labelTitle.Text = Strings.Fluid.SUPERHEAT_ABRV;
          break;
        case Fluid.EState.Dew:
          labelTitle.Text = Strings.Fluid.SUBCOOL_ABRV;
          break;
        default:
          labelTitle.Text = Strings.UNKNOWN;
          break;
      }

      if (sensorProperty.pressureSensor == null || sensorProperty.temperatureSensor == null) {
        labelMeasurement.Text = Strings.Workbench.Viewer.SHSC_SETUP;        
      } else {
        var meas = sensorProperty.modifiedMeasurement;
        labelMeasurement.Text = SensorUtils.ToFormattedString(ESensorType.Temperature, meas, true);
      }
    }

    private void UpdateToFluid(Fluid fluid) {
      labelFluid.Text = fluid.name;
      labelFluid.BackgroundColor = new UIColor(Colors.FromInt((uint)fluid.color));
    }
	}
}
